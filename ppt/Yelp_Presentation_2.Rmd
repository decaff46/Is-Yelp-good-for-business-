---
title: "5243 Final Project Report"
author: "Team XKL"
date: "April 25, 2019"
output: slidy_presentaion
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(rmarkdown)
library(knitr)
library(Hmisc)
library(DT)
library(tidyverse)
library(scales)
library(arules)
library(ggplot2)
library(gridExtra)
library(data.table)
library(base)
library(ggrepel)
library(mapdata)
library(RColorBrewer)
library(scales)
library(lattice)
library(tidyverse)
# library(dplyr)
library(magrittr)
library(plotly)
library(leaflet,quietly=TRUE)
library(maps,quietly=TRUE)

assignInNamespace("cedta.override", value = c(data.table:::cedta.override,"rmarkdown"), ns = "data.table")


opts_chunk$set(echo = FALSE, comment="", warning = FALSE, message = FALSE, tidy.opts=list(width.cutoff=55), tidy = TRUE)
```

```{r read_data, include=FALSE, eval = TRUE}
setwd("~/Applied Data Science/Final Proj/Data")
business <- fread(input = "business.csv", verbose = FALSE)
business.df <- read.csv("business.csv")
user <- fread(input = "user.csv", verbose = FALSE)
restaurant <- fread(input = "restaurant.csv")
```

```{r constants}
cities.name <- c("All", "Phoenix", "Las Vegas")
business.id.name = "business_id"
business.name.name = "name"
address.name= "address"
city.name = "city"
state.name = "state"
zipcode.name = "postal_code"
latitude.name = "latitude"
longitude.name = "longitude"
stars.name = "stars"
review.coutn.name = "review_count"
category.name = "categories"
is.open.name = "is_open"
cuisine.name = "cuisine.info"
attributes = business[, c(2,13:51)]
hour = business[, c(2,53:59)]
new.business = business[,c(2:12, 52)]

user.id.name = "user_id"
elite.name = "elite"
friends.name = "friends"
average.stars.name = "average_stars"
helpful.name = "helpful"
fans.name = "fans"
num.of.elites.name = "num_of_elites"
num.of.friends.name = "num_of_friends"
final.score.name = "final_score"
influencer.name = "influencer"
user.key.cols.names <- c("review_count","useful","fans","num_of_elites","num_of_friends")

pattern.attributes <- "Attributes_"
attributes.list <- names(business)[grep(pattern = pattern.attributes, x = names(business))]

unique.id <- business[, unique(get(business.id.name))]
unique.name <- business[, unique(get(business.name.name))]
unique.address <- business[, unique(get(address.name))]
unique.city <- business[, unique(get(city.name))]
unique.state <- business[, unique(get(state.name))]
unique.zipcod <- business[, unique(get(zipcode.name))]
unique.cuisine <- restaurant[, unique(get(cuisine.name))]
unique.restaurant <- restaurant[, unique(get(business.id.name))]

num.business <- length(unique.id)
num.restaurant <- length(unique.restaurant)
num.cuisine <- length(unique.cuisine)

respondent.variables <- c(city.name, state.name, cuisine.name, review.coutn.name, stars.name)
dependent.variables <- c(is.open.name)
```

```{r functions}
percentage.table <- function(x, digits = 1){
  tab <- table(x)
  number.tab <- 100*tab/(sum(tab))
  rounded.tab <- round(x = percentage.tab, digits = digits)
  return(rounded.tab)
}

round.numerics <- function(x, digits){
  if(is.numeric(x)){
    x <- round(x = x, digits = digits)
  }
  return(x)
}

count_num <- function(x){
  l<- unlist(strsplit(x, split=",", fixed = TRUE))
  return (length(l))
}

scaling_user <- function(x){
  return((x-min(x, na.rm=TRUE))/(max(x, na.rm=TRUE)-min(x, na.rm=TRUE)))
}
```

```{r cleaned dat}
## Clean data ################################################################################################################

# NA starts and review count is considered to be 0 
business.df$stars[is.na(business.df$stars)] <- 0
business.df$review_count[is.na(business.df$review_count)] <- 0

#NA in Hours is considered to be 00:00
hours <- grepl("hours.", names(business.df))
business.df[hours] <- replace(business.df[hours], is.na(business.df[hours]), "00:00")
business.df[hours] <- lapply(business.df[hours], as.factor)

## restaurants.types ################################################################################################################

restaurants.types <- business.df %>% 
  select(business_id, city, state, name, address, latitude, longitude, stars, review_count, 
         Attributes_RestaurantsPriceRange2, categories, stars, is_open) %>%
  filter(str_detect(categories, "Restaurant")) %>%
  mutate(categories2 = as.character(categories)) %>%
  unnest(categories) %>% 
  as.data.table(.)

# head(business.df)
```


## Introduction

  Yelp data contains `r num.business` of unique businesses with `r num.restaurant` of unique restaurants. We categorized the restaurants by their cuisines, and there are `r num.cuisine` different number of cuisines.  


## Is Yelp Beneficial to A Businessâ€™s Sustainability?

  It is often said that making ourselves *Visible* online is a key factor of success. Yet, according to the actual users, it is not helpful at all.

![](C:/Users/caffr/OneDrive/Documents/Applied Data Science/Final Proj/ppt/bad_review.png)
```{r}
renderImage({
  # filename <- normalizePath(file.path('./images',
                                      # paste('image', input$n, '.jpeg', sep='')))
  filename <- ("")

    # Return a list containing the filename
    list(src = filename,
         # contentType = 'image/png',
         width = 600,
         height = 400,
         alt = "This is alternate text")
  }, deleteFile = FALSE)
```

## Overview of User Dataset

```{r}
user[, `:=`(eval(num.of.elites.name),count_num(elite)), by= V1]
user[, `:=`(eval(num.of.friends.name),count_num(friends)), by= V1]
names(user)
```

## Number of Reviews Per User

```{r}
# Summary of number of reviews per user
user[, summary(get(review.coutn.name))]

# Plot Number of Reviews per User
ggplot(user)+
  geom_density(aes(get(review.coutn.name)),fill = "coral3", color="coral3")+
  labs(title = "Number of Reviews per User")+
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")

# Plot users with less than 75 reviews
ggplot(subset(user,get(review.coutn.name)<=75))+
  geom_histogram(aes(review_count), fill = "coral3", color = "white", binwidth = 4)+
  labs(title = "Number of Reviews per User (<=75)")+
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

## Average Rating Per User

```{r}
# Summary of users' average ratings
user[, summary(get(average.stars.name))]

# Plot users' average ratings
ggplot(user)+
  geom_histogram(aes(get(average.stars.name)),fill = "coral3", color="white", binwidth = 0.1)+
  labs(title = "Average Ratings")+
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

## Number of Years Being An Elite Member

```{r}
# Summary of Number of Years Being A Elite Member
user[, summary(get(num.of.elites.name))]

# Plot Number of Years Being A Elite Member
ggplot(user)+
  geom_histogram(aes(get(num.of.elites.name)),fill = "coral3", color="white", binwidth = 0.5)+
  labs(title = "Number of Years Being A Elite Member")+ 
  xlim(-0.5,6.5)+
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

## Number of Friends Per User

```{r}
# Summary of Number of Friends per User
user[, summary(get(num.of.friends.name))]

# Plot Number of Friends per User
ggplot(user)+
  geom_density(aes(get(num.of.friends.name)),fill = "coral3", color="coral3")+
  labs(title = "Number of Friends per User")+
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")

# Plot users with less than 30 friends
ggplot(subset(user,get(num.of.friends.name)<=30))+
  geom_histogram(aes(get(num.of.friends.name)), fill = "coral3", color = "white", binwidth = 1)+
  labs(title = "Number of Friends per User (<=30)")+
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

## Key Attributes of User

```{r}
# Create a new data.table to store key attributes
user_key_attributes <- cbind(user[, get(user.id.name)], user[, lapply(X = .SD, FUN = scaling_user), .SDcols = user.key.cols.names])
setnames(x = user_key_attributes, old = "V1", new = "user_id")

# Calculate final score for each user
user_key_attributes[,eval(final.score.name):=20*get(review.coutn.name)+20*useful+20*fans+20*num_of_elites+20*num_of_friends]

# Summary of all scores
#user_key_attributes[, summary(get(final.score.name))]

# Define influencers
user_key_attributes[, eval(influencer.name):=1*(get(final.score.name) > mean(get(final.score.name))+sd(get(final.score.name)))]

# Summary of influencers
user_key_attributes[, summary(get(influencer.name))]

datatable(data=user_key_attributes[1:100,lapply(X = .SD, 
    FUN = "round.numerics", digits = 3)], rownames = FALSE)
```

## Overview of Business Dataset

```{r}
datatable(head(restaurant,20), rownames = FALSE)
```

## Visualization of All Businesses

```{r, out.width="100%"}
states <- data.table(map_data("state"))
business_sum <- business[, .(num = .N, mean_stars = mean(get(stars.name)), long = mean(get(longitude.name)), lat = mean(get(latitude.name))), keyby = state.name]
restaurant_sum <- restaurant[, .(num = .N, mean_stars = mean(get(stars.name)), long = mean(get(longitude.name)), lat = mean(get(latitude.name))), keyby = state.name]
two_states_reg <- subset(states, (region=="arizona")|(region=="nevada"))
two_states_sum <- subset(restaurant_sum, (state=="AZ")|(state=="NV"))
two_cites <- subset(restaurant, (city=="Phoenix")|(city=="Las Vegas"))


# Plot all businesses in the U.S.
ggplot() + 
  geom_polygon(data = states, aes(x = long, y = lat, group = group), color = "white", fill = "grey") + 
  coord_fixed(1.3) + guides(fill=FALSE)  +
geom_point(data=business_sum, aes(x=long, y=lat, colour=mean_stars, size=num)) +
  scale_size(name="Number of Businesses") +
  geom_label_repel(data=business_sum, aes(x=long, y=lat, label=state, fill = factor(state)), size=2 ) +
  labs(title = "All Businesses in the US and Canada") +
  theme(plot.title = element_text(hjust = 0.5))
```

## Top 10 Categories in Business Dataset

```{r}
# Tracking top famous categories in Yelp business data
category.tab = data.table(Category = unlist(strsplit(new.business$categories, ",")))

category.tab = category.tab[, .N, by = Category]
setnames(x = category.tab, old = "N", new = "Count")
setorderv(x = category.tab, cols = "Count", order = -1)

#datatable(category.tab)

# Visualize the Top 10 categories
top10_category_plot = ggplot(data = category.tab[1:10], aes(x = reorder(Category, Count), y = Count, fill = Category)) +
  geom_bar(stat = "identity", color = "black") +
  geom_text(aes(x = Category, y = 1, 
                label = paste0("(",round(Count/1e3)," K )",sep="")), hjust=0, vjust=.5, size = 3, colour = 'black', fontface = 'bold') +
  labs(x = 'Category', 
       y = 'Count', 
       title = 'Top 10 Category in Yelp') +
  coord_flip()+
  theme_bw()

print(top10_category_plot)
```

Unlike what we thought, Yelp has other business listed in their data besides restaurants. However, like the original thought, majority of the data is about restauratns and we would like to only deal only with restaurants. Hence, we will take a look at the restaurant data only!


## Visualization of All Restaurants

```{r, out.width="100%"}
ggplot() + 
  geom_polygon(data = states, aes(x = long, y = lat, group = group), color = "white", fill = "grey") + 
  coord_fixed(1.3) + guides(fill=FALSE)  +
geom_point(data=restaurant_sum, aes(x=long, y=lat, colour=mean_stars, size=num)) +
  scale_size(name="Number of Restaurants") +
  geom_label_repel(data=restaurant_sum, aes(x=long, y=lat, label=state, fill = factor(state)), size=2 ) +
  labs(title = "All Restaurants in the US and Canada") +
  theme(plot.title = element_text(hjust = 0.5))
```


## City, State, Stars, Cuisine, Review_count


```{r Business, out.width="100%", height = 500}
inputPanel(
  selectInput(inputId="respondent_variable", label = "Select Variable:", choices = respondent.variables, selected = respondent.variables[1]),
  
  sliderInput(inputId="respondent_number", label = "Select Number of Variables:", min = 1, max = 10, value = 5, step = 1),
  
  checkboxInput(inputId = "show_number", label = "Show Number", value = TRUE)
)

## check box 
renderPlot({
  tab <- restaurant[, .N, by = eval(input$respondent_variable)]
  setorderv(tab, cols = "N", order = -1)
  
  tab_n = tab[1 :input$respondent_number,]
  
  ggplot(tab_n, aes(x = get(input$respondent_variable), y = N, fill = get(input$respondent_variable))) +
  geom_bar(stat = 'identity', color = "black") +
  theme(legend.position = "none") +
  labs(x = eval(input$respondent_variable), 
       y = 'Count', 
       title = sprintf('Top %d %s in Yelp', input$respondent_num_variable, input$respondent_variable)) +
    if(input$show_number == T){
      geom_text(aes(label = sprintf("%d", N)), vjust = -0.3, size = 4) 
    }

})
```

## Las Vegas Cuisines

```{r}
vegas.surviving = restaurant[get(city.name) == "Las Vegas", .("# of restaurants" = .N, surviving.rate = mean(is_open,na.rm = TRUE)), by = cuisine.info ]
setorderv(vegas.surviving,"# of restaurants",-1)
#datatable(vegas.surviving)

datatable(data=vegas.surviving[,lapply(X = .SD, 
    FUN = "round.numerics", digits = 3)], rownames = FALSE)
```


## Las Vegas Top Cuisines

```{r, out.width="100%"}
inputPanel(
  sliderInput(inputId = "cuisine_num_lv", label = "Select Number of Cuisines:", min = 1, max = 10, step = 1, value = 4)
)
# Plot Pie Chart for Top 4 Cuisines in Las Vegas
renderPlot({
  num.res.name <- "# of restaurants"
  vegas.surviving[, share:=get(num.res.name)/sum(get(num.res.name))]

  p1 <- ggplot(vegas.surviving[2:(2+input$cuisine_num_lv-1)], aes(x="", y=share, fill=cuisine.info)) +
    geom_bar(stat="identity", width=1, color = "white") +
    coord_polar("y", start=0) + geom_text(aes(label = paste0(round(share*100), "%")), position = position_stack(vjust = 0.5), color = "white") + 
  theme_void() + 
  labs(title = sprintf("Pie Chart for Top %s Cuisines in Las Vegas", input$cuisine_num_lv)) +
  theme(plot.title = element_text(hjust = 0.5))

# Plot Las Vegas Only
  top_n_cuisine_lv <- vegas.surviving[, cuisine.info][2:(2+input$cuisine_num_lv-1)]
  las.vegas <- subset(restaurant, (city == "Las Vegas") & (cuisine.info %in% top_n_cuisine_lv))
  #summary(las.vegas[,latitude])
  #summary(las.vegas[,longitude])

  p2 <- ggplot() + 
    geom_point(data=las.vegas, aes(x=longitude, y=latitude, colour=factor(cuisine.info), size=review_count)) + ylim(35.98,36.32) + xlim(-115.36,-115.05) +
    labs(title = "Restaurants in Las Vegas") +
    theme(plot.title = element_text(hjust = 0.5))
  
  grid.arrange(p1,p2,ncol=2,widths = c(3,5))
})
```


## Phoenix Cuisines

```{r}
phoenix.surviving = restaurant[get(city.name) == "Phoenix", .("# of restaurants" = .N, surviving.rate = mean(is_open,na.rm = TRUE)), by = cuisine.info ]
setorderv(phoenix.surviving,"# of restaurants",-1)
#datatable(phoenix.surviving)
datatable(data=phoenix.surviving[,lapply(X = .SD, 
    FUN = "round.numerics", digits = 3)], rownames = FALSE)
```

## Phoenix Top Cuisines

```{r, out.width="100%"}
inputPanel(
  sliderInput(inputId = "cuisine_num_px", label = "Select Number of Cuisines:", min = 1, max = 10, step = 1, value = 4)
)

renderPlot({
  # Plot Pie Chart for Top 4 Cuisines in Phoenix
  num.res.name <- "# of restaurants"
  phoenix.surviving[, share:=get(num.res.name)/sum(get(num.res.name))]

  p1 <- ggplot(phoenix.surviving[2:(2+input$cuisine_num_px-1)], aes(x="", y=share, fill=cuisine.info)) +
    geom_bar(stat="identity", width=1, color = "white") +
    coord_polar("y", start=0) + geom_text(aes(label = paste0(round(share*100), "%")), position = position_stack(vjust = 0.5), color = "white") + 
    theme_void() + 
    labs(title = sprintf("Pie Chart for Top %s Cuisines in Phoenix", input$cuisine_num_px)) +
    theme(plot.title = element_text(hjust = 0.5))

  # Plot Phoenix Only
  top_n_cuisine_px <- phoenix.surviving[, cuisine.info][2:(2+input$cuisine_num_px-1)]
  phoenix <- subset(restaurant, (city == "Phoenix") & (cuisine.info %in% top_n_cuisine_px))
  #summary(phoenix[,latitude])
  #summary(phoenix[,longitude])

 p2 <- ggplot() + 
    geom_point(data=phoenix, aes(x=longitude, y=latitude, colour=factor(cuisine.info), size=review_count)) + ylim(33.28,33.72) + xlim(-112.32,-111.88) +
    labs(title = "Restaurants in Phoenix") +
    theme(plot.title = element_text(hjust = 0.5))
  
  grid.arrange(p1,p2,ncol=2,widths = c(3,5))
})

```

## Distribution of Stars by Is_open

```{r Star distribution by is_open}
star.dist.by.open = restaurant[, .N, by = c(is.open.name, 'stars')]

star.dist.by.open_plot = 
  ggplot(star.dist.by.open, aes(x = stars, y = N, fill = factor(is_open))) +
  geom_bar(stat = 'identity',position = 'dodge') +
  scale_color_brewer(palette = "Spectral") +
  xlab("Stars") +
  ylab("Count") +
  ggtitle("Star Distribution Between Open and Close") +
  theme(plot.title = element_text(size=9.5))

print(star.dist.by.open_plot)
```

It seems that star distribution does not really tells us much stories about why a store is closed when the other store is still open. 

To have a better understanding what affect surviving rate in those two cities, we will take text mining and machine learning predcitions (Lasso or Ridge to find out the key features)


## Interactive Map to View Open/Close Restaurants

```{r map_input, out.width="100%"}
inputPanel(
  selectInput(inputId="area", label = "Area:", choices = cities.name, selected = cities.name[1]),
  checkboxInput(inputId = "open_checkbox", label = "Only show open restaurants", value=TRUE)
  
  # selectInput(inputId="cat", label = "Cuisines:", choices = cities.name, selected = cities.name[1])
  # selectInput(inputId="area", label = "Area:", choices = cities.name, selected = cities.name[1])
)

subdat <- restaurants.types[get(city.name) %in% "Phoenix"]

renderLeaflet({
  
  # Filter Area
  if (input$area != "All") {
      subdat <- restaurants.types[get(city.name) %in% input$area]
    }else
      subdat <- restaurants.types
  
  # # Filter by category
  # if (input$cat != "All") {
  #     m <- m[which(grepl(input$business_category, m$categories)), ]
  #   }else
  #     subdat <- business.df
    
  # Filter open business
  if (input$open_checkbox==TRUE) {
    subdat <- subdat[get(is.open.name)==1]
    }else
      subdat <- subdat

  pop <- paste0("<strong>City: </strong>",
                  subdat$city, "<br>",
                  "<strong>Business: </strong>",
                  subdat$name, "<br>",
                  "<strong>Categories: </strong>",
                  subdat$categories, "</br>",
                  "<strong>Price Range: </strong>",
                  subdat$Attributes_RestaurantsPriceRange2, "<br>",
                  "<strong>Stars: </strong>",
                  subdat$stars)
  
  pal = colorFactor(c('#B5AFEB','#E7F3B6'), domain = subdat$is_open)
  
  subdat %>%
    leaflet() %>%
    # addTiles() %>%
    addTiles(urlTemplate = "http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png")  %>%
    # setView(lat = 36.164277, lng = -115.1111, zoom = 12) %>%
    mapOptions(zoomToLimits="always") %>%
    addCircles(~longitude, ~latitude, color = ~pal(subdat$is_open), weight = 3, opacity = 0.7,popup = pop, group = "Restaurants") %>%
    addMarkers(lat=subdat$latitude, lng=subdat$longitude,
    clusterOptions = markerClusterOptions(), popup=pop)
  })
```


```{r Wordcloud}

```
