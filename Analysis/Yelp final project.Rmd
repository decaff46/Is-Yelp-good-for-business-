---
title: "Yelp_fianl Project"
author: "Caffrey Lee"
date: "April 13, 2019"
output: slidy_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Yelp Helps?

Nowadays, it is important to make ourselves visible 'Online.' Especially, for local business, whom considered to have limited budget to advertise themselves via traditional media such as TV, radio, news paper, magainze. Luckly, there are number of platforms help them to reach out to potential customers. Yelp is an outstanding example of it. However, most of the Yelp Business users have commented very badly on the service and even recommend others not to use it. Starting from here, we decided to investigate whether making visible on Yelp helps a local business owner to sustain their business. 

## Setting up Library

```{r, message = F, warning = F, echo = F }
library(data.table)
library(DT)
library(ggplot2)
library(gridExtra)
library(leaflet)
```

## Importing the data

```{r, message = F, warning = F, echo = F}
business = fread("~/Applied Data Science/Final Proj/Data/yelp_business.csv")
```

## Business Dataset
1. Explore the data

```{r Splitting Data}
# Spliting the business into 3 diff datasets : business, attribute, and hour
attributes = business[, c(2,13:51)]
hour = business[, c(2,53:59)]
new.business = business[,c(2:12, 52)]

business.id.name = "business_id"
name.name = "name"
address.name= "address"
city.name = "city"
state.name = "state"
zipcode.name = "postal_code"
latitude.name = "latitude"
longitude.name = "longitude"
review.coutn.name = "review_count"
category.name = "categories"
is.open.name = "is_open"


```

```{r Exploring - Category, echo = T}
# Tracking top famous categories in Yelp business data
category.tab = data.table(Category = unlist(strsplit(new.business$categories, ",")))

category.tab = category.tab[, .N, by = Category]
setnames(x = category.tab, old = "N", new = "Count")
setorderv(x = category.tab, cols = "Count", order = -1)

datatable(category.tab)

# Visualize the Top 10 categories
top10_category_plot = ggplot(data = category.tab[1:10], aes(x = reorder(Category, Count), y = Count, fill = Category)) +
  geom_bar(stat = "identity", color = "black") +
  geom_text(aes(x = Category, y = 1, 
                label = paste0("(",round(Count/1e3)," K )",sep="")), hjust=0, vjust=.5, size = 3, colour = 'black', fontface = 'bold') +
  labs(x = 'Category', 
       y = 'Count', 
       title = 'Top 10 Category in Yelp') +
  coord_flip()+
  theme_bw()

print(top10_category_plot)
```

Unlike what we thought, Yelp has other business listed in their data besides restaurants. However, like the original thought, majority of the data is about restauratns and we woudl like to deal only with restaurants. Hence, we will exclude the restaunts only. Now, let's take a look at the restaurant data only!

``` {r Exploring - extracting restaurants from category }

w = new.business[, grepl(pattern = "Restaurants", x = categories)]
restaurant = new.business[w, ]
# From now on we will work on restaurant dataset, instead of new.business

# Find what is the most famous cuisine among the ones I named in restaurant
cuisine.list = c('Ainu', 'Albanian','Argentina','Andhra', 'Anglo-Indian', 'Arab', 'Armenian', 'Assyrian', 'Awadhi', 'Azerbaijani', 'Balochi', 'Belarusian', 'Bangladeshi', 'Bengali',    'Berber', 'Buddhist', 'Bulgarian', 'Cajun', 'Chechen', 'Chinese',    'Chinese Islamic', 'Circassian', 'Crimean Tatar', 'Cypriot', 'Danish', 'Estonian', 'French', 'Filipino', 'Georgian', 'Goan', 
'Goan Catholic', 'Greek', 'Gujarati', 'Hyderabad', 'Indian', 'Indian Chinese', 'Singaporean', 'Indonesian', 'Inuit', 'Italian American', 'Italian', 'Japanese', 'Jewish', 'Karnataka', 'Kazakh', 'Keralite', 'Korean', 'Kurdish', 'Laotian','Latvian', 'Lithuanian', 'Louisiana Creole', 'Maharashtrian', 'Mangalorean', 'Malay', 'Chinese', 'Malaysian', 'Indian', 'Mediterranean', 'Mexican', 'Mordovian', 'Mughal','Native American', 'Nepalese', 'New Mexican', 'Odia', 'Parsi', 'Pashtun', 'Polish', 'Pennsylvania Dutch', 'Pakistani', 'Peranakan', 'Persian', 'Peruvian', 'Portuguese', 'Punjabi', 'Rajasthani', 'Romanian', 'Russian', 'Sami', 'Serbian', 'Sindhi', 'Slovak', 'Slovenian', 'Somali', 'South Indian', 'Sri Lankan', 'Taiwanese', 'Tatar', 'Thai', 'Turkish', 'Tamil', 'Udupi', 'Ukrainian', 'Yamal', 'Zanzibari', 'American')
# reference: https://en.wikipedia.org/wiki/List_of_cuisines

# Adding Cuisine.info into the restaurant table.
categories.list <- strsplit(restaurant$categories, ", ")
cuisine.info <- c()
for (i in 1:nrow(restaurant)){
  if (any(categories.list[[i]]%in% cuisine.list) == FALSE){
    cuision = "others"
  } else{
    cuision <- categories.list[[i]][which(categories.list[[i]] %in% cuisine.list)]
    if(length(cuision)>1){
      cuision <- cuision[1]
    }
  }
  cuisine.info <- append(cuisine.info, cuision)
}

restaurant.w.cuisine = cbind(restaurant,cuisine.info)

restaurant.w.cuisine[cuisine.info %in% c('American (New)', 'Breakfast & Brunch', 'Burgers', 'Fast Food','American (Traditional)', 'Breakfast & Brunch', 'Burgers', 'Barbeque', 'Steakhouses', 'Sandwiches', 'Pizza', 'Hot Dogs'),cuisine.info:="American"]
restaurant.w.cuisine[cuisine.info %in% c('Soul Food'),cuisine.info:="Korean"]
restaurant.w.cuisine[cuisine.info %in% c('Sushi Bars'),cuisine.info:="Japanese"]

cuisine.tab <- restaurant.w.cuisine[,.N, by = cuisine.info]
setnames(cuisine.tab, old = 'cuisine.info', new = "Cuisine")
setnames(cuisine.tab, old = 'N', new = "Count")
setorderv(x = cuisine.tab, cols = 'Count', order = -1)

# Visualize the Top 10 cuisine
top10_cuisine_plot = ggplot(data = cuisine.tab[2:11], aes(x = reorder(Cuisine, Count), y = Count, fill = Cuisine)) +
  geom_bar(stat = "identity", color = "black") +
  geom_text(aes(x = Cuisine, y = 1, 
                label = paste0("(",round(Count/1e3)," K )",sep="")), hjust=-0.5, vjust=.5, size = 3, colour = 'black', fontface = 'bold') +
  labs(x = 'Cuisine', 
       y = 'Count', 
       title = 'Top 10 Cuisine in Yelp') +
  coord_flip()+
  theme_bw()

print(top10_cuisine_plot)
## what if we use this to categorize the restaurants into one single cuisine?
```

Mexican, 6K, and Italian, 5K, are the most famous cuisine in the restaurants. Let's now find more information about locations : state and city. 

```{r Exploring City and State }
# business by state
state.tab = restaurant.w.cuisine[, .(Count = .N), by = state]
setorderv(state.tab, cols = 'Count', order = -1)

state_plot = ggplot(data = state.tab[1:10],aes(x = reorder(state, Count),y = Count, fill = state)) +
  geom_bar(stat='identity',colour="white") +
  geom_text(aes(x = state, y = 1, label = paste0("(",round(Count/1e3)," K )",sep="")), hjust=0, vjust=.5, size = 4, colour = 'black', fontface = 'bold') +
  labs(x = 'State', 
       y = 'Count', 
       title = 'Top 10 States in Yelp') +
  coord_flip() + 
  theme_bw()

# business by city
city.tab = restaurant.w.cuisine[, .(Count = .N), by = city]
setorderv(city.tab, cols = "Count", order = -1)

city_plot = ggplot(data = city.tab[1:10],aes(x = reorder(city, Count),y = Count, fill = city)) +
  geom_bar(stat='identity',colour="white") +
  geom_text(aes(x = city, y = 1, label = paste0("(",round(Count/1e3)," K )",sep="")), hjust=0, vjust=.5, size = 4, colour = 'black', fontface = 'bold') +
  labs(x = 'City', 
       y = 'Count', 
       title = 'Top 10 Cities in Yelp') +
  coord_flip() + 
  theme_bw()

grid.arrange(state_plot, city_plot)
```

It seems that Ontario, a state in Canada, has the most restaurant dataset in Yelp, followed by Arizona and Nevada. And, this pattern reflects on the City dataset as well: Toronto, a city in Ontario, has the most information. Yet, Las Vegas has the second most restaurant information while Phoenix has the third most dataset. From here, we could say that daat regarding Arizona is not focused in Phoenix but spread. Let's see how many cities are listed under Arizona and Nevada.

```{r Cities in Arizona}
AZ_cities_numb = restaurant.w.cuisine[get(state.name) == "AZ", length(unique(get(city.name)))]
print(AZ_cities_numb) # 57

NV_cities_numb = restaurant.w.cuisine[get(state.name) == "NV", length(unique(get(city.name)))]
print(NV_cities_numb) # 23

AZ_NV_restaurant_numb = restaurant.w.cuisine[get(state.name) == "AZ" | get(state.name) == "NV", .N]
print(AZ_NV_restaurant_numb)
```

As we presumed, the number of city,`r AZ_cities_numb`,listed under AZ is greater than that uner NV,`r NV_cities_numb`. 

Anyhow, we decided to take more closer look into those two cities, Las Vegas and Phoenix. We will try to find any intersting facts and restaurants from those two locations based on other variables such as survival rates, numbers of same type of cuisine restaurants, and such.   


First, let's take a look at the Surviving rate of each state. 

```{r Exploring Is_open}
# Overall surviving rate 
overall.surviving.rate = restaurant.w.cuisine[, .N, by = is.open.name]
overall.surviving.rate = overall.surviving.rate[1,2]/nrow(restaurant) 
# Simply take a look at the number of restaurants are open and close
vegas.open.tab = restaurant.w.cuisine[get(city.name) == "Las Vegas", .N , by = is.open.name]
phoenix.open.tab = restaurant.w.cuisine[get(city.name) == "Phoenix", .N , by = is.open.name]



# Calcualting survival rates for both
vegas.open.tab[, Total := sum(N)]
vegas.open.tab[, Rate := (N/Total)*100]
setorderv(vegas.open.tab, cols = 'is_open', order = -1)
vegas.surviving.rate = vegas.open.tab[1,4]

phoenix.open.tab[, Total := sum(N)]
phoenix.open.tab[, Rate := (N/Total)*100]
phoenix.surviving.rate = phoenix.open.tab[1,4]

vegas.surviving.rate > phoenix.surviving.rate
vegas.open.tab[1,4] > phoenix.open.tab[1,4] 
```

In genearl, Vegas has more restaurants, including both still in business and not in business anymore. Yet, the surviving rate in Vegas is lower than Phoenix. In other words, restaurant business is more competitive in Vegas than in Phoenix.

Now, let's take a look at the competitiveness by cuisine.

```{r Competitiveness by cuisine}
vegas.surviving = restaurant.w.cuisine[get(city.name) == "Las Vegas", .("# of restaurants" = .N, surviving.rate = mean(is_open,na.rm = TRUE)), by = cuisine.info ]
setorderv(vegas.surviving,"# of restaurants",-1)
datatable(vegas.surviving)

phoenix.surviving = restaurant.w.cuisine[get(city.name) == "Phoenix", .("# of restaurants" = .N, surviving.rate = mean(is_open,na.rm = TRUE)), by = cuisine.info ]
setorderv(phoenix.surviving,"# of restaurants",-1)
datatable(phoenix.surviving)
```



Let's take a look star distribution by Is_open
```{r Star distribution by is_open}
star.dist.by.open = restaurant.w.cuisine[, .N, by = c(is.open.name, 'stars')]

star.dist.by.open_plot = 
  ggplot(star.dist.by.open, aes(x = stars, y = N, fill = factor(is_open))) +
  geom_bar(stat = 'identity',position = 'dodge') +
  scale_color_brewer(palette = "Spectral") +
  xlab("Stars") +
  ylab("Count") +
  ggtitle("Star Distribution Between Open and Close") +
  theme(plot.title = element_text(size=9.5))

print(star.dist.by.open_plot)
```

It seems that star distribution does not really tells us much stories about why a store is closed when the other store is still open. 

To have a better understanding what affect surviving rate in those two cities, we will take text mining and machine learning predcitions (Lasso or Ridge to find out the key features)

```{r }

```


